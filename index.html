<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP Malangu√≠simas - Sistema Multiusuario</title>
    
    <!-- Firebase SDK v9+ -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            doc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot,
            query,
            orderBy,
            serverTimestamp,
            enableNetwork,
            disableNetwork
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAA74GDCBz99C2c1J8ngoJwVaFXMRyHaLg",
            authDomain: "erp-malanguisimas.firebaseapp.com",
            projectId: "erp-malanguisimas",
            storageBucket: "erp-malanguisimas.firebasestorage.app",
            messagingSenderId: "168435151109",
            appId: "1:168435151109:web:7c9eeb80a1a023fba1876c",
            measurementId: "G-SL1MHR7V8S"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Hacer las funciones disponibles globalmente
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.orderBy = orderBy;
        window.serverTimestamp = serverTimestamp;
        window.enableNetwork = enableNetwork;
        window.disableNetwork = disableNetwork;

        // Indicar que Firebase est√° listo
        window.firebaseReady = true;
        window.dispatchEvent(new Event('firebaseReady'));
    </script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        .hidden { display: none !important; }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #f97316;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Indicador de sincronizaci√≥n -->
    <div id="syncIndicator" class="fixed top-4 right-4 z-50">
        <div class="bg-white rounded-lg shadow-lg px-4 py-2 flex items-center space-x-2">
            <div id="syncStatus" class="flex items-center">
                <div class="w-2 h-2 bg-gray-400 rounded-full mr-2"></div>
                <span class="text-sm text-gray-600">Conectando...</span>
            </div>
        </div>
    </div>

    <!-- Loader Global -->
    <div id="globalLoader" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
            <div class="loader mb-4"></div>
            <p class="text-gray-600">Procesando...</p>
        </div>
    </div>

    <!-- Contenedor Principal -->
    <div id="app" class="min-h-screen">
        <!-- Barra Superior -->
        <nav class="bg-white shadow-lg">
            <div class="px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-fire text-2xl text-orange-500"></i>
                    <h1 class="text-xl font-bold text-gray-800">Malangu√≠simas ERP</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">
                        <i class="fas fa-users mr-1"></i>
                        <span id="activeUsers">Sistema Multiusuario</span>
                    </span>
                    <button onclick="refreshData()" class="bg-gray-500 text-white px-3 py-2 rounded hover:bg-gray-600 transition text-sm">
                        <i class="fas fa-sync mr-1"></i>Actualizar
                    </button>
                </div>
            </div>
        </nav>

        <!-- Contenido Principal -->
        <div class="p-6">
            <!-- Men√∫ de navegaci√≥n -->
            <div class="bg-white rounded-lg shadow-lg p-4 mb-6">
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-2">
                    <button onclick="showSection('dashboard')" class="menu-btn px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 transition">
                        <i class="fas fa-home mr-1"></i>Inicio
                    </button>
                    <button onclick="showSection('productos')" class="menu-btn px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition">
                        <i class="fas fa-box mr-1"></i>Productos
                    </button>
                    <button onclick="showSection('ventas')" class="menu-btn px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition">
                        <i class="fas fa-shopping-cart mr-1"></i>Ventas
                    </button>
                    <button onclick="showSection('compras')" class="menu-btn px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition">
                        <i class="fas fa-truck mr-1"></i>Compras
                    </button>
                    <button onclick="showSection('contabilidad')" class="menu-btn px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition">
                        <i class="fas fa-calculator mr-1"></i>Contabilidad
                    </button>
                    <button onclick="showSection('reportes')" class="menu-btn px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition">
                        <i class="fas fa-chart-bar mr-1"></i>Reportes
                    </button>
                    <button onclick="showSection('configuracion')" class="menu-btn px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition">
                        <i class="fas fa-cog mr-1"></i>Config
                    </button>
                </div>
            </div>

            <!-- Secci√≥n Dashboard -->
            <section id="dashboard" class="content-section">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Dashboard Principal</h2>
                
                <!-- Tarjetas de m√©tricas -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">Ventas del Mes</p>
                                <p class="text-2xl font-bold text-gray-800" id="ventasMes">$0.00</p>
                            </div>
                            <i class="fas fa-chart-line text-3xl text-green-500"></i>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">Productos en Stock</p>
                                <p class="text-2xl font-bold text-gray-800" id="totalStock">0</p>
                            </div>
                            <i class="fas fa-box text-3xl text-blue-500"></i>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">Clientes Activos</p>
                                <p class="text-2xl font-bold text-gray-800" id="clientesActivos">0</p>
                            </div>
                            <i class="fas fa-users text-3xl text-purple-500"></i>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">Utilidad Neta</p>
                                <p class="text-2xl font-bold text-gray-800" id="utilidadNeta">$0.00</p>
                            </div>
                            <i class="fas fa-dollar-sign text-3xl text-orange-500"></i>
                        </div>
                    </div>
                </div>

                <!-- Gr√°ficos -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Ventas por Sabor</h3>
                        <div class="relative h-64">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Tendencia de Ventas (7 d√≠as)</h3>
                        <div class="relative h-64">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Secci√≥n Productos -->
            <section id="productos" class="content-section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Gesti√≥n de Productos</h2>
                    <button onclick="showProductForm()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 transition">
                        <i class="fas fa-plus mr-2"></i>Nuevo Producto
                    </button>
                </div>

                <!-- Formulario de Producto -->
                <div id="productForm" class="hidden bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Agregar/Editar Producto</h3>
                    <form id="productFormElement" onsubmit="saveProduct(event)">
                        <input type="hidden" id="productId">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Producto</label>
                                <input type="text" id="productName" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Categor√≠a</label>
                                <select id="productCategory" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-orange-500">
                                    <option value="chips">Chips de Malanga</option>
                                    <option value="otros">Otros Productos</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tama√±o</label>
                                <select id="productSize" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-orange-500">
                                    <option value="50g">50 gramos</option>
                                    <option value="100g">100 gramos</option>
                                    <option value="otro">Otro</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Sabor</label>
                                <select id="productFlavor" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-orange-500">
                                    <option value="fuego">Fuego</option>
                                    <option value="habanero">Habanero</option>
                                    <option value="jalape√±o">Jalape√±o</option>
                                    <option value="misterio">Misterio</option>
                                    <option value="adobadas">Adobadas</option>
                                    <option value="naturales">Naturales</option>
                                    <option value="especias">Especias</option>
                                    <option value="chipotle">Chipotle</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Precio Mayoreo</label>
                                <input type="number" id="wholesalePrice" step="0.01" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Precio Menudeo</label>
                                <input type="number" id="retailPrice" step="0.01" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Stock Inicial</label>
                                <input type="number" id="initialStock" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">C√≥digo de Barras</label>
                                <input type="text" id="barcode" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-orange-500">
                            </div>
                        </div>
                        <div class="mt-4 flex gap-2">
                            <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition">
                                <i class="fas fa-save mr-2"></i>Guardar
                            </button>
                            <button type="button" onclick="hideProductForm()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Lista de Productos -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Producto</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tama√±o</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sabor</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Stock</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">P. Mayoreo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">P. Menudeo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="productsList" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                                        <div class="flex justify-center">
                                            <div class="loader"></div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Secci√≥n Ventas -->
            <section id="ventas" class="content-section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Registro de Ventas</h2>
                    <button onclick="showSaleForm()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 transition">
                        <i class="fas fa-plus mr-2"></i>Nueva Venta
                    </button>
                </div>

                <!-- Formulario de Venta -->
                <div id="saleForm" class="hidden bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Registrar Venta</h3>
                    <form id="saleFormElement" onsubmit="saveSale(event)">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Cliente</label>
                                <input type="text" id="customerName" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Cliente</label>
                                <select id="customerType" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-orange-500" onchange="updateAllPrices()">
                                    <option value="menudeo">Menudeo</option>
                                    <option value="mayoreo">Mayoreo</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                                <input type="date" id="saleDate" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                            </div>
                        </div>

                        <!-- L√≠neas de Venta -->
                        <div class="border rounded p-4 mb-4">
                            <h4 class="font-semibold text-gray-700 mb-3">Productos</h4>
                            <div id="saleLines" class="space-y-2"></div>
                            <button type="button" onclick="addSaleLine()" class="mt-3 text-orange-600 hover:text-orange-700">
                                <i class="fas fa-plus mr-1"></i>Agregar Producto
                            </button>
                        </div>

                        <div class="flex justify-between items-center pt-4 border-t">
                            <div class="text-xl font-bold">
                                Total: $<span id="saleTotal">0.00</span>
                            </div>
                            <div class="flex gap-2">
                                <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition">
                                    <i class="fas fa-check mr-2"></i>Registrar Venta
                                </button>
                                <button type="button" onclick="hideSaleForm()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition">
                                    Cancelar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Lista de Ventas -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="salesList" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                        <div class="flex justify-center">
                                            <div class="loader"></div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Secci√≥n Compras -->
            <section id="compras" class="content-section hidden">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Gesti√≥n de Compras</h2>
                    <p class="text-gray-600">M√≥dulo de compras en desarrollo...</p>
                </div>
            </section>

            <!-- Secci√≥n Contabilidad -->
            <section id="contabilidad" class="content-section hidden">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">M√≥dulo de Contabilidad</h2>
                    <p class="text-gray-600">Sistema contable en desarrollo...</p>
                </div>
            </section>

            <!-- Secci√≥n Reportes -->
            <section id="reportes" class="content-section hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Reportes Financieros</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition">
                        <i class="fas fa-file-invoice-dollar text-4xl text-green-500 mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Estado de Resultados</h3>
                        <p class="text-gray-600 mb-4">Genera el estado de resultados del per√≠odo</p>
                        <button onclick="generateReport('resultados')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition w-full">
                            <i class="fas fa-print mr-2"></i>Generar
                        </button>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition">
                        <i class="fas fa-boxes text-4xl text-indigo-500 mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Inventario</h3>
                        <p class="text-gray-600 mb-4">Estado actual del inventario</p>
                        <button onclick="generateReport('inventario')" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600 transition w-full">
                            <i class="fas fa-list mr-2"></i>Ver Inventario
                        </button>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition">
                        <i class="fas fa-chart-pie text-4xl text-orange-500 mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">An√°lisis de Ventas</h3>
                        <p class="text-gray-600 mb-4">Reportes detallados de ventas</p>
                        <button onclick="generateReport('ventas')" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 transition w-full">
                            <i class="fas fa-chart-bar mr-2"></i>Analizar
                        </button>
                    </div>
                </div>

                <!-- Visor de Reportes -->
                <div id="reportViewer" class="hidden mt-6 bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="reportTitle" class="text-lg font-semibold text-gray-800"></h3>
                        <div class="flex gap-2">
                            <button onclick="window.print()" class="text-gray-600 hover:text-gray-800">
                                <i class="fas fa-print text-xl"></i>
                            </button>
                            <button onclick="closeReportViewer()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                    <div id="reportContent" class="overflow-x-auto"></div>
                </div>
            </section>

            <!-- Secci√≥n Configuraci√≥n -->
            <section id="configuracion" class="content-section hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Configuraci√≥n del Sistema</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Estado del Sistema -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Estado del Sistema</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                                <span class="text-sm text-gray-600">Estado Firebase:</span>
                                <span id="firebaseStatus" class="font-semibold">
                                    <i class="fas fa-circle text-gray-400 mr-1"></i>Verificando...
                                </span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                                <span class="text-sm text-gray-600">Modo:</span>
                                <span class="font-semibold">Multiusuario sin autenticaci√≥n</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                                <span class="text-sm text-gray-600">Sincronizaci√≥n:</span>
                                <span class="font-semibold">Tiempo Real</span>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n de la Empresa -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Informaci√≥n de la Empresa</h3>
                        <form id="empresaForm" onsubmit="saveCompanyInfo(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre de la Empresa</label>
                                <input type="text" id="empresaNombre" value="Malangu√≠simas" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-orange-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n</label>
                                <textarea id="empresaDescripcion" rows="3" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-orange-500">Chips de Malanga Artesanales</textarea>
                            </div>
                            <button type="submit" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 transition">
                                <i class="fas fa-save mr-2"></i>Guardar Cambios
                            </button>
                        </form>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        // Variables globales
        let products = [];
        let sales = [];
        let currentSection = 'dashboard';
        let unsubscribeProducts = null;
        let unsubscribeSales = null;
        let chartInstances = {};
        let isConnected = false;

        // Esperar a que Firebase est√© listo
        function waitForFirebase() {
            if (window.firebaseReady) {
                initializeApp();
            } else {
                window.addEventListener('firebaseReady', initializeApp);
            }
        }

        // Inicializar la aplicaci√≥n
        async function initializeApp() {
            console.log('Inicializando aplicaci√≥n con Firebase...');
            
            try {
                // Verificar conexi√≥n con Firebase
                await testFirebaseConnection();
                
                // Establecer fecha actual
                document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];
                
                // Configurar listeners en tiempo real
                setupRealtimeListeners();
                
                // Actualizar estado de conexi√≥n
                updateConnectionStatus(true);
                
            } catch (error) {
                console.error('Error inicializando:', error);
                updateConnectionStatus(false);
                showError('No se pudo conectar con Firebase. Verifica tu conexi√≥n.');
            }
        }

        // Verificar conexi√≥n con Firebase
        async function testFirebaseConnection() {
            try {
                const testRef = collection(db, 'test');
                await getDocs(testRef);
                console.log('‚úÖ Conexi√≥n con Firebase exitosa');
                isConnected = true;
            } catch (error) {
                console.error('‚ùå Error conectando con Firebase:', error);
                isConnected = false;
                throw error;
            }
        }

        // Configurar listeners en tiempo real
        function setupRealtimeListeners() {
            // Listener para productos
            const productsQuery = query(collection(db, 'products'), orderBy('createdAt', 'desc'));
            unsubscribeProducts = onSnapshot(productsQuery, (snapshot) => {
                products = [];
                snapshot.forEach((doc) => {
                    products.push({ id: doc.id, ...doc.data() });
                });
                updateProductsList();
                updateDashboard();
                console.log('üì¶ Productos actualizados:', products.length);
            }, (error) => {
                console.error('Error en listener de productos:', error);
            });

            // Listener para ventas
            const salesQuery = query(collection(db, 'sales'), orderBy('createdAt', 'desc'));
            unsubscribeSales = onSnapshot(salesQuery, (snapshot) => {
                sales = [];
                snapshot.forEach((doc) => {
                    sales.push({ id: doc.id, ...doc.data() });
                });
                updateSalesList();
                updateDashboard();
                console.log('üõí Ventas actualizadas:', sales.length);
            }, (error) => {
                console.error('Error en listener de ventas:', error);
            });
        }

        // Actualizar estado de conexi√≥n
        function updateConnectionStatus(connected) {
            const statusDiv = document.getElementById('syncStatus');
            const firebaseStatusEl = document.getElementById('firebaseStatus');
            
            if (connected) {
                statusDiv.innerHTML = `
                    <div class="w-2 h-2 bg-green-500 rounded-full mr-2 pulse"></div>
                    <span class="text-sm text-green-600">Conectado</span>
                `;
                firebaseStatusEl.innerHTML = '<i class="fas fa-circle text-green-500 mr-1"></i>Conectado';
            } else {
                statusDiv.innerHTML = `
                    <div class="w-2 h-2 bg-red-500 rounded-full mr-2"></div>
                    <span class="text-sm text-red-600">Sin conexi√≥n</span>
                `;
                firebaseStatusEl.innerHTML = '<i class="fas fa-circle text-red-500 mr-1"></i>Desconectado';
            }
        }

        // Mostrar/ocultar loader
        function showLoader() {
            document.getElementById('globalLoader').classList.remove('hidden');
        }

        function hideLoader() {
            document.getElementById('globalLoader').classList.add('hidden');
        }

        // Mostrar error
        function showError(message) {
            alert(message);
        }

        // Funciones de navegaci√≥n
        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.add('hidden'));
            document.getElementById(section).classList.remove('hidden');
            
            document.querySelectorAll('.menu-btn').forEach(btn => {
                btn.className = btn.className.replace('bg-orange-500 text-white', 'bg-gray-200 text-gray-700');
            });
            event.target.className = event.target.className.replace('bg-gray-200 text-gray-700', 'bg-orange-500 text-white');
            
            currentSection = section;
        }

        // Funciones de productos
        function showProductForm() {
            document.getElementById('productForm').classList.remove('hidden');
            document.getElementById('productFormElement').reset();
            document.getElementById('productId').value = '';
        }

        function hideProductForm() {
            document.getElementById('productForm').classList.add('hidden');
        }

        async function saveProduct(event) {
            event.preventDefault();
            
            if (!isConnected) {
                showError('No hay conexi√≥n con Firebase');
                return;
            }
            
            showLoader();
            
            const productId = document.getElementById('productId').value;
            const productData = {
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                size: document.getElementById('productSize').value,
                flavor: document.getElementById('productFlavor').value,
                wholesalePrice: parseFloat(document.getElementById('wholesalePrice').value),
                retailPrice: parseFloat(document.getElementById('retailPrice').value),
                stock: parseInt(document.getElementById('initialStock').value),
                barcode: document.getElementById('barcode').value || null
            };
            
            try {
                if (productId) {
                    // Actualizar producto existente
                    await updateDoc(doc(db, 'products', productId), {
                        ...productData,
                        updatedAt: serverTimestamp()
                    });
                    showError('Producto actualizado exitosamente');
                } else {
                    // Crear nuevo producto
                    await addDoc(collection(db, 'products'), {
                        ...productData,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });
                    showError('Producto guardado exitosamente');
                }
                
                hideProductForm();
            } catch (error) {
                console.error('Error guardando producto:', error);
                showError('Error al guardar el producto');
            } finally {
                hideLoader();
            }
        }

        async function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            document.getElementById('productId').value = productId;
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productSize').value = product.size;
            document.getElementById('productFlavor').value = product.flavor;
            document.getElementById('wholesalePrice').value = product.wholesalePrice;
            document.getElementById('retailPrice').value = product.retailPrice;
            document.getElementById('initialStock').value = product.stock;
            document.getElementById('barcode').value = product.barcode || '';
            
            showProductForm();
        }

        async function deleteProduct(productId) {
            if (!confirm('¬øEst√°s seguro de eliminar este producto?')) return;
            
            if (!isConnected) {
                showError('No hay conexi√≥n con Firebase');
                return;
            }
            
            showLoader();
            
            try {
                await deleteDoc(doc(db, 'products', productId));
                showError('Producto eliminado exitosamente');
            } catch (error) {
                console.error('Error eliminando producto:', error);
                showError('Error al eliminar el producto');
            } finally {
                hideLoader();
            }
        }

        function updateProductsList() {
            const tbody = document.getElementById('productsList');
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No hay productos registrados</td></tr>';
                return;
            }
            
            tbody.innerHTML = products.map(product => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${product.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.size}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.flavor}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${product.stock < 10 ? 'text-red-600 font-bold' : 'text-gray-500'}">${product.stock}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${product.wholesalePrice.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${product.retailPrice.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editProduct('${product.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteProduct('${product.id}')" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Funciones de ventas
        function showSaleForm() {
            document.getElementById('saleForm').classList.remove('hidden');
            document.getElementById('saleFormElement').reset();
            document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('saleLines').innerHTML = '';
            addSaleLine();
        }

        function hideSaleForm() {
            document.getElementById('saleForm').classList.add('hidden');
        }

        function addSaleLine() {
            const lineId = Date.now();
            const lineHTML = `
                <div class="sale-line grid grid-cols-1 md:grid-cols-5 gap-2 p-2 border rounded" data-line-id="${lineId}">
                    <select class="product-select px-3 py-2 border rounded md:col-span-2" onchange="updateSaleLinePrice(${lineId})">
                        <option value="">Seleccionar producto</option>
                        ${products.map(p => `<option value="${p.id}" data-wholesale="${p.wholesalePrice}" data-retail="${p.retailPrice}">${p.name} - ${p.size} - ${p.flavor}</option>`).join('')}
                    </select>
                    <input type="number" class="quantity-input px-3 py-2 border rounded" placeholder="Cantidad" min="1" onchange="updateSaleTotal()">
                    <input type="number" class="price-input px-3 py-2 border rounded" placeholder="Precio" step="0.01" readonly>
                    <div class="flex gap-2">
                        <input type="number" class="subtotal-input flex-1 px-3 py-2 border rounded" placeholder="Subtotal" step="0.01" readonly>
                        <button type="button" onclick="removeSaleLine(${lineId})" class="text-red-500 hover:text-red-700 px-3">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('saleLines').insertAdjacentHTML('beforeend', lineHTML);
        }

        function updateSaleLinePrice(lineId) {
            const line = document.querySelector(`[data-line-id="${lineId}"]`);
            const productSelect = line.querySelector('.product-select');
            const priceInput = line.querySelector('.price-input');
            const customerType = document.getElementById('customerType').value;
            
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            if (selectedOption.value) {
                const price = customerType === 'mayoreo' 
                    ? parseFloat(selectedOption.dataset.wholesale)
                    : parseFloat(selectedOption.dataset.retail);
                priceInput.value = price.toFixed(2);
            }
            
            updateSaleTotal();
        }

        function updateAllPrices() {
            document.querySelectorAll('.sale-line').forEach(line => {
                const lineId = line.dataset.lineId;
                updateSaleLinePrice(lineId);
            });
        }

        function removeSaleLine(lineId) {
            document.querySelector(`[data-line-id="${lineId}"]`).remove();
            updateSaleTotal();
        }

        function updateSaleTotal() {
            let total = 0;
            document.querySelectorAll('.sale-line').forEach(line => {
                const quantity = parseFloat(line.querySelector('.quantity-input').value) || 0;
                const price = parseFloat(line.querySelector('.price-input').value) || 0;
                const subtotal = quantity * price;
                line.querySelector('.subtotal-input').value = subtotal.toFixed(2);
                total += subtotal;
            });
            document.getElementById('saleTotal').textContent = total.toFixed(2);
        }

        async function saveSale(event) {
            event.preventDefault();
            
            if (!isConnected) {
                showError('No hay conexi√≥n con Firebase');
                return;
            }
            
            const lines = [];
            let hasValidLines = false;
            
            document.querySelectorAll('.sale-line').forEach(line => {
                const productId = line.querySelector('.product-select').value;
                const quantity = parseInt(line.querySelector('.quantity-input').value) || 0;
                const price = parseFloat(line.querySelector('.price-input').value) || 0;
                const subtotal = parseFloat(line.querySelector('.subtotal-input').value) || 0;
                
                if (productId && quantity > 0) {
                    lines.push({ productId, quantity, price, subtotal });
                    hasValidLines = true;
                }
            });
            
            if (!hasValidLines) {
                showError('Agrega al menos un producto a la venta');
                return;
            }
            
            showLoader();
            
            const saleData = {
                customerName: document.getElementById('customerName').value,
                customerType: document.getElementById('customerType').value,
                date: document.getElementById('saleDate').value,
                lines: lines,
                total: parseFloat(document.getElementById('saleTotal').textContent),
                status: 'completada',
                createdAt: serverTimestamp()
            };
            
            try {
                // Guardar venta
                await addDoc(collection(db, 'sales'), saleData);
                
                // Actualizar stock de productos
                for (const line of lines) {
                    const productRef = doc(db, 'products', line.productId);
                    const product = products.find(p => p.id === line.productId);
                    if (product) {
                        await updateDoc(productRef, {
                            stock: product.stock - line.quantity
                        });
                    }
                }
                
                showError('Venta registrada exitosamente');
                hideSaleForm();
            } catch (error) {
                console.error('Error registrando venta:', error);
                showError('Error al registrar la venta');
            } finally {
                hideLoader();
            }
        }

        function updateSalesList() {
            const tbody = document.getElementById('salesList');
            
            if (sales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No hay ventas registradas</td></tr>';
                return;
            }
            
            tbody.innerHTML = sales.map(sale => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${sale.customerName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${sale.customerType === 'mayoreo' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                            ${sale.customerType}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${sale.total.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                            ${sale.status || 'completada'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="viewSale('${sale.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function viewSale(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) return;
            
            let detailsHTML = '<h4 class="font-semibold mb-2">Productos:</h4><ul class="list-disc pl-5">';
            for (const line of sale.lines) {
                const product = products.find(p => p.id === line.productId);
                detailsHTML += `<li>${product ? product.name : 'Producto eliminado'} - Cantidad: ${line.quantity} - Precio: $${line.price.toFixed(2)} - Subtotal: $${line.subtotal.toFixed(2)}</li>`;
            }
            detailsHTML += '</ul>';
            
            const content = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600">Cliente:</p>
                            <p class="font-semibold">${sale.customerName}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Tipo:</p>
                            <p class="font-semibold">${sale.customerType}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Fecha:</p>
                            <p class="font-semibold">${sale.date}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Total:</p>
                            <p class="font-semibold text-xl">$${sale.total.toFixed(2)}</p>
                        </div>
                    </div>
                    <div>${detailsHTML}</div>
                </div>
            `;
            
            showReport('Detalle de Venta', content);
        }

        // Actualizar dashboard
        function updateDashboard() {
            // Calcular m√©tricas
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const ventasMes = sales.filter(sale => {
                const saleDate = new Date(sale.date);
                return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
            }).reduce((sum, sale) => sum + sale.total, 0);
            
            const totalStock = products.reduce((sum, product) => sum + product.stock, 0);
            const clientesUnicos = new Set(sales.map(s => s.customerName)).size;
            const utilidadNeta = ventasMes * 0.3; // 30% de margen estimado
            
            // Actualizar valores
            document.getElementById('ventasMes').textContent = `$${ventasMes.toFixed(2)}`;
            document.getElementById('totalStock').textContent = totalStock;
            document.getElementById('clientesActivos').textContent = clientesUnicos;
            document.getElementById('utilidadNeta').textContent = `$${utilidadNeta.toFixed(2)}`;
            
            // Actualizar gr√°ficos
            updateCharts();
        }

        function updateCharts() {
            // Destruir gr√°ficos existentes
            Object.values(chartInstances).forEach(chart => {
                if (chart) chart.destroy();
            });
            
            // Gr√°fico de ventas por sabor
            const salesByFlavor = {};
            sales.forEach(sale => {
                sale.lines.forEach(line => {
                    const product = products.find(p => p.id === line.productId);
                    if (product) {
                        salesByFlavor[product.flavor] = (salesByFlavor[product.flavor] || 0) + line.subtotal;
                    }
                });
            });
            
            const ctx1 = document.getElementById('salesChart');
            if (ctx1 && Object.keys(salesByFlavor).length > 0) {
                chartInstances.salesChart = new Chart(ctx1.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(salesByFlavor),
                        datasets: [{
                            data: Object.values(salesByFlavor),
                            backgroundColor: [
                                '#ff6384', '#ff9f40', '#4bc0c0', '#9966ff', 
                                '#ffce56', '#36a2eb', '#ff6384', '#c9c9c9'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
            
            // Gr√°fico de tendencia
            const last7Days = [];
            const salesByDay = {};
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                last7Days.push(dateStr);
                salesByDay[dateStr] = 0;
            }
            
            sales.forEach(sale => {
                if (salesByDay.hasOwnProperty(sale.date)) {
                    salesByDay[sale.date] += sale.total;
                }
            });
            
            const ctx2 = document.getElementById('trendChart');
            if (ctx2) {
                chartInstances.trendChart = new Chart(ctx2.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: last7Days.map(d => {
                            const date = new Date(d);
                            return date.toLocaleDateString('es-MX', { day: 'numeric', month: 'short' });
                        }),
                        datasets: [{
                            label: 'Ventas',
                            data: last7Days.map(date => salesByDay[date]),
                            borderColor: 'rgb(251, 146, 60)',
                            backgroundColor: 'rgba(251, 146, 60, 0.1)',
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Funciones de reportes
        function generateReport(type) {
            const viewer = document.getElementById('reportViewer');
            const title = document.getElementById('reportTitle');
            const content = document.getElementById('reportContent');
            
            viewer.classList.remove('hidden');
            
            switch(type) {
                case 'inventario':
                    const totalValue = products.reduce((sum, p) => sum + (p.stock * p.wholesalePrice), 0);
                    
                    title.textContent = 'Reporte de Inventario';
                    content.innerHTML = `
                        <div class="space-y-4">
                            <div class="bg-gray-50 p-4 rounded">
                                <p class="text-lg font-semibold">Resumen</p>
                                <p>Total de productos: ${products.length}</p>
                                <p>Unidades totales: ${products.reduce((sum, p) => sum + p.stock, 0)}</p>
                                <p>Valor total: $${totalValue.toFixed(2)}</p>
                            </div>
                            <table class="min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left">Producto</th>
                                        <th class="px-4 py-2 text-center">Stock</th>
                                        <th class="px-4 py-2 text-right">Valor</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${products.map(p => `
                                        <tr class="${p.stock < 10 ? 'bg-red-50' : ''}">
                                            <td class="px-4 py-2">${p.name} ${p.size} - ${p.flavor}</td>
                                            <td class="px-4 py-2 text-center ${p.stock < 10 ? 'text-red-600 font-bold' : ''}">${p.stock}</td>
                                            <td class="px-4 py-2 text-right">$${(p.stock * p.wholesalePrice).toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    break;
                    
                case 'ventas':
                    const salesByProduct = {};
                    const salesByType = { mayoreo: 0, menudeo: 0 };
                    
                    sales.forEach(sale => {
                        salesByType[sale.customerType] += sale.total;
                        sale.lines.forEach(line => {
                            const product = products.find(p => p.id === line.productId);
                            if (product) {
                                const key = `${product.name} ${product.size}`;
                                salesByProduct[key] = (salesByProduct[key] || 0) + line.subtotal;
                            }
                        });
                    });
                    
                    title.textContent = 'An√°lisis de Ventas';
                    content.innerHTML = `
                        <div class="space-y-6">
                            <div>
                                <h3 class="font-bold text-lg mb-3">Ventas por Tipo de Cliente</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-blue-50 p-4 rounded">
                                        <p class="text-sm text-gray-600">Mayoreo</p>
                                        <p class="text-2xl font-bold text-blue-600">$${salesByType.mayoreo.toFixed(2)}</p>
                                    </div>
                                    <div class="bg-green-50 p-4 rounded">
                                        <p class="text-sm text-gray-600">Menudeo</p>
                                        <p class="text-2xl font-bold text-green-600">$${salesByType.menudeo.toFixed(2)}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h3 class="font-bold text-lg mb-3">Ventas por Producto</h3>
                                <table class="min-w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left">Producto</th>
                                            <th class="px-4 py-2 text-right">Total Vendido</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${Object.entries(salesByProduct)
                                            .sort((a, b) => b[1] - a[1])
                                            .map(([product, total]) => `
                                                <tr>
                                                    <td class="px-4 py-2">${product}</td>
                                                    <td class="px-4 py-2 text-right font-semibold">$${total.toFixed(2)}</td>
                                                </tr>
                                            `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'resultados':
                    const ventas = sales.reduce((sum, s) => sum + s.total, 0);
                    const costoVentas = ventas * 0.6;
                    const utilidadBruta = ventas - costoVentas;
                    const gastosOperacion = ventas * 0.2;
                    const utilidadOperacion = utilidadBruta - gastosOperacion;
                    const isr = utilidadOperacion * 0.3;
                    const utilidadNeta = utilidadOperacion - isr;
                    
                    title.textContent = 'Estado de Resultados';
                    content.innerHTML = `
                        <table class="min-w-full">
                            <tbody>
                                <tr class="border-b">
                                    <td class="py-2">Ventas Netas</td>
                                    <td class="py-2 text-right">$${ventas.toFixed(2)}</td>
                                </tr>
                                <tr class="border-b">
                                    <td class="py-2">(-) Costo de Ventas</td>
                                    <td class="py-2 text-right">$${costoVentas.toFixed(2)}</td>
                                </tr>
                                <tr class="font-bold bg-gray-50 border-b">
                                    <td class="py-2">Utilidad Bruta</td>
                                    <td class="py-2 text-right">$${utilidadBruta.toFixed(2)}</td>
                                </tr>
                                <tr class="border-b">
                                    <td class="py-2">(-) Gastos de Operaci√≥n</td>
                                    <td class="py-2 text-right">$${gastosOperacion.toFixed(2)}</td>
                                </tr>
                                <tr class="font-bold bg-gray-50 border-b">
                                    <td class="py-2">Utilidad de Operaci√≥n</td>
                                    <td class="py-2 text-right">$${utilidadOperacion.toFixed(2)}</td>
                                </tr>
                                <tr class="border-b">
                                    <td class="py-2">(-) ISR (30%)</td>
                                    <td class="py-2 text-right">$${isr.toFixed(2)}</td>
                                </tr>
                                <tr class="font-bold bg-gray-100">
                                    <td class="py-2">UTILIDAD NETA</td>
                                    <td class="py-2 text-right">$${utilidadNeta.toFixed(2)}</td>
                                </tr>
                            </tbody>
                        </table>
                    `;
                    break;
            }
        }

        function showReport(title, content) {
            document.getElementById('reportTitle').textContent = title;
            document.getElementById('reportContent').innerHTML = content;
            document.getElementById('reportViewer').classList.remove('hidden');
        }

        function closeReportViewer() {
            document.getElementById('reportViewer').classList.add('hidden');
        }

        // Funci√≥n para actualizar datos manualmente
        async function refreshData() {
            showLoader();
            try {
                await testFirebaseConnection();
                updateConnectionStatus(true);
                showError('Datos actualizados');
            } catch (error) {
                updateConnectionStatus(false);
                showError('Error al actualizar');
            } finally {
                hideLoader();
            }
        }

        // Guardar informaci√≥n de la empresa
        async function saveCompanyInfo(event) {
            event.preventDefault();
            showError('Informaci√≥n guardada localmente');
        }

        // Limpiar listeners al salir
        window.addEventListener('beforeunload', () => {
            if (unsubscribeProducts) unsubscribeProducts();
            if (unsubscribeSales) unsubscribeSales();
        });

        // Iniciar aplicaci√≥n cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', waitForFirebase);

        // Reconexi√≥n autom√°tica
        window.addEventListener('online', () => {
            console.log('Conexi√≥n restablecida');
            refreshData();
        });

        window.addEventListener('offline', () => {
            console.log('Sin conexi√≥n');
            updateConnectionStatus(false);
        });
    </script>
</body>
</html>